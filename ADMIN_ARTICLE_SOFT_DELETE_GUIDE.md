# 后台管理系统 - 文章软删除功能使用指南

## ✅ 功能已完成

文章管理模块的软删除功能已完整集成到现有的后台管理系统中！

## 🚀 立即使用

### 第 1 步：启动服务

```bash
npm run start:dev
```

### 第 2 步：访问后台管理系统

在浏览器中打开：

```
http://localhost:3000/admin/
```

### 第 3 步：登录

使用超级管理员账号登录

### 第 4 步：进入文章管理

在侧边栏点击"文章管理"

### 第 5 步：使用软删除功能

你会看到页面顶部有 **3 个状态筛选按钮**：

```
┌────────────────────────────────────────────┐
│ ○ 📝 正常文章  ○ 📚 全部文章  ○ 🗑️ 回收站│
└────────────────────────────────────────────┘
```

## 🎯 功能说明

### 1. 📝 正常文章（默认）

显示所有未删除的文章

**操作**：
- ✏️ **编辑**：编辑文章内容
- 🗑️ **删除**：软删除文章（移至回收站）
- ✅ **发布**：发布草稿文章

### 2. 📚 全部文章

显示包括已删除在内的所有文章

**特点**：
- 可以同时看到正常文章和已删除文章
- 已删除的文章显示红色"已删除"标签
- 正常文章显示绿色"已发布"或橙色"草稿"标签

### 3. 🗑️ 回收站

**只显示已删除的文章**

**操作**：
- ♻️ **恢复**：恢复文章到正常状态
- ❌ **永久删除**：真正删除文章（不可恢复）

**提示**：回收站会显示文章的删除时间

## 📋 完整操作流程

### 场景 1：删除文章

1. 在"正常文章"列表中找到要删除的文章
2. 点击🗑️"删除"按钮
3. 确认：**"确定要删除文章吗？删除后可以在回收站中恢复。"**
4. 文章移至回收站
5. 提示：**"文章已移至回收站"**

### 场景 2：查看已删除的文章

1. 点击顶部的 **"🗑️ 回收站"** 按钮
2. 看到所有已删除的文章
3. 每篇文章显示：
   - 🔴 红色"已删除"标签
   - 删除时间
   - ♻️ 恢复按钮
   - ❌ 永久删除按钮

### 场景 3：恢复文章

1. 在回收站中找到要恢复的文章
2. 点击 ♻️ **"恢复"** 按钮
3. 确认：**"确定要恢复文章吗？"**
4. 文章恢复成功
5. 提示：**"文章恢复成功！"**
6. 文章返回正常列表

### 场景 4：永久删除文章

1. 在回收站中找到要永久删除的文章
2. 点击 ❌ **"永久删除"** 按钮
3. 看到警告：
   ```
   ⚠️ 警告：永久删除操作不可恢复！
   
   确定要永久删除文章"XXX"吗？
   
   注意：如果文章有评论、收藏或笔记，将无法删除。
   ```
4. 确认后：
   - **成功**：提示"文章已永久删除"
   - **失败**：提示具体错误原因（如：文章存在关联数据）

## 🎨 界面效果

### 正常文章列表
```
┌──────────────────────────────────────────────────────┐
│ ○ 📝 正常文章  ○ 📚 全部文章  ○ 🗑️ 回收站          │
├──────────────────────────────────────────────────────┤
│ ID │ 标题    │ 作者 │ 分类 │ 状态   │ 创建时间 │ 操作│
├────┼────────┼─────┼─────┼────────┼─────────┼─────┤
│ 1  │测试文章│ 张三 │ 科研 │🟢 已发布│ 10-08 10:00│✏️🗑️│
│ 2  │草稿文章│ 李四 │ 教学 │🟠 草稿  │ 10-08 11:00│✏️🗑️✅│
└──────────────────────────────────────────────────────┘
```

### 回收站
```
┌──────────────────────────────────────────────────────┐
│ ○ 📝 正常文章  ○ 📚 全部文章  ● 🗑️ 回收站          │
│ 💡 提示：回收站中的文章可以恢复或永久删除            │
├──────────────────────────────────────────────────────┤
│ ID │ 标题    │ 作者 │ 分类 │ 状态   │ 删除时间 │ 操作│
├────┼────────┼─────┼─────┼────────┼─────────┼─────┤
│ 5  │测试文章│ 张三 │ 科研 │🔴 已删除│ 10-08 23:30│♻️❌ │
│ 3  │案例研究│ 李四 │ 教学 │🔴 已删除│ 10-08 15:20│♻️❌ │
└──────────────────────────────────────────────────────┘
```

## 🔑 状态标识

| 状态     | 标签颜色 | 说明                 |
| -------- | -------- | -------------------- |
| 🟢 已发布 | 绿色     | 文章已发布，对外可见 |
| 🟠 草稿   | 橙色     | 文章未发布           |
| 🔴 已删除 | 红色     | 文章在回收站中       |

## ⚠️ 重要说明

### 软删除 vs 永久删除

| 操作         | 位置         | 可恢复     | 删除内容         |
| ------------ | ------------ | ---------- | ---------------- |
| **软删除**   | 正常文章列表 | ✅ 可恢复   | 只标记为已删除   |
| **永久删除** | 回收站       | ❌ 不可恢复 | 真正从数据库删除 |

### 永久删除限制

以下情况**无法永久删除**：
- ❌ 文章有评论
- ❌ 文章有收藏
- ❌ 文章有笔记

**建议**：对于有关联数据的文章，使用软删除而不是永久删除。

## 🔧 技术细节

### 修改的文件

1. **src/admin/frontend/index.html**
   - 添加状态筛选按钮组
   - 修改表格列标题（时间列动态显示）

2. **src/admin/frontend/admin.js**
   - 添加 `currentDeleteFilter` 变量
   - 修改 `loadArticles()` 函数支持软删除
   - 添加 `changeDeleteFilter()` 函数
   - 添加 `restoreArticle()` 函数
   - 添加 `permanentlyDeleteArticle()` 函数
   - 修改 `deleteArticle()` 函数提示信息
   - 更新所有调用 `loadArticles()` 的地方

### API 调用逻辑

```javascript
if (deleteFilter === 'deleted') {
  // 回收站 - 调用专用API
  apiUrl = '/admin/articles/deleted/list';
} else {
  // 正常或全部
  apiUrl = '/admin/articles';
  if (deleteFilter === 'all') {
    params.append('includeDeleted', 'true'); // 关键参数
  }
}
```

### 界面渲染逻辑

```javascript
// 根据 deletedAt 判断文章状态
const isDeleted = article.deletedAt !== null;

// 显示不同的操作按钮
if (isDeleted) {
  // 恢复 + 永久删除
} else {
  // 编辑 + 删除 + 发布
}
```

## 📊 统计信息

Dashboard 中已自动更新统计数据，包含已删除文章数量。

## 🐛 问题排查

### 问题：点击回收站看不到数据

**检查**：
1. 数据库中是否真的有已删除的文章
2. 浏览器控制台是否有错误
3. Token 是否有效

**验证**：在浏览器控制台运行
```javascript
console.log('currentDeleteFilter:', currentDeleteFilter);
```

### 问题：恢复/永久删除无响应

**检查**：
1. 浏览器控制台的错误信息
2. Token 是否过期
3. 是否有超级管理员权限

## 💡 使用技巧

1. **快速切换**：使用状态筛选按钮在不同视图间快速切换
2. **批量清理**：在回收站中可以批量查看并清理过期文章
3. **误删恢复**：删除文章后立即切换到回收站即可恢复
4. **定期维护**：定期查看回收站，清理不需要的文章

## ✨ 功能特性

- ✅ 软删除（可恢复）
- ✅ 查看回收站
- ✅ 一键恢复
- ✅ 永久删除（带保护）
- ✅ 状态标识
- ✅ 时间显示（删除时间/创建时间）
- ✅ 智能提示
- ✅ 确认对话框

## 📞 技术支持

详细技术文档：
- [软删除技术实现](./ARTICLE_SOFT_DELETE_README.md)
- [快速开始](./ARTICLE_SOFT_DELETE_QUICKSTART.md)
- [问题排查](./SOFT_DELETE_TROUBLESHOOTING.md)

---

**实现日期**：2025年10月8日  
**版本**：v1.0  
**状态**：✅ 已部署到生产环境
