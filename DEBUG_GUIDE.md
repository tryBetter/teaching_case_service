# NestJS è°ƒè¯•æŒ‡å—

## âœ… è°ƒè¯•é…ç½®å·²å®Œæˆ

VS Code è°ƒè¯•é…ç½®æ–‡ä»¶å·²åˆ›å»ºï¼š`.vscode/launch.json`

## ğŸš€ å¦‚ä½•ä½¿ç”¨è°ƒè¯•

### æ–¹æ³• 1ï¼šä½¿ç”¨ VS Code è°ƒè¯•å™¨ï¼ˆæ¨èï¼‰â­

#### æ­¥éª¤ 1ï¼šæ‰“æ–­ç‚¹

1. åœ¨ VS Code ä¸­æ‰“å¼€ä½ è¦è°ƒè¯•çš„æ–‡ä»¶ï¼ˆå¦‚ `src/auth/guards/roles.guard.ts`ï¼‰
2. åœ¨ä»£ç è¡Œå·å·¦ä¾§ç‚¹å‡»ï¼Œå‡ºç°çº¢ç‚¹å³ä¸ºæ–­ç‚¹
3. å¯ä»¥æ‰“å¤šä¸ªæ–­ç‚¹

#### æ­¥éª¤ 2ï¼šå¯åŠ¨è°ƒè¯•

æœ‰ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼ Aï¼šç›´æ¥å¯åŠ¨è°ƒè¯•**
1. æŒ‰ `F5` é”®
2. æˆ–ç‚¹å‡»å·¦ä¾§"è¿è¡Œå’Œè°ƒè¯•"å›¾æ ‡
3. é€‰æ‹©"è°ƒè¯• NestJS åº”ç”¨"
4. ç‚¹å‡»ç»¿è‰²æ’­æ”¾æŒ‰é’®

**æ–¹å¼ Bï¼šé™„åŠ åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹**
1. å…ˆåœ¨ç»ˆç«¯è¿è¡Œï¼š`npm run start:debug`
2. æŒ‰ `F5` æˆ–ç‚¹å‡»è°ƒè¯•æŒ‰é’®
3. é€‰æ‹©"é™„åŠ åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹"

#### æ­¥éª¤ 3ï¼šè§¦å‘æ–­ç‚¹

1. å‘é€ API è¯·æ±‚ï¼ˆPostman / Swagger / curlï¼‰
2. å½“ä»£ç æ‰§è¡Œåˆ°æ–­ç‚¹æ—¶ä¼šè‡ªåŠ¨æš‚åœ
3. åœ¨ VS Code ä¸­æŸ¥çœ‹å˜é‡å€¼

#### æ­¥éª¤ 4ï¼šè°ƒè¯•æ“ä½œ

- **ç»§ç»­ï¼ˆF5ï¼‰**ï¼šç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹
- **å•æ­¥è·³è¿‡ï¼ˆF10ï¼‰**ï¼šæ‰§è¡Œå½“å‰è¡Œï¼Œä¸è¿›å…¥å‡½æ•°å†…éƒ¨
- **å•æ­¥è¿›å…¥ï¼ˆF11ï¼‰**ï¼šè¿›å…¥å‡½æ•°å†…éƒ¨
- **å•æ­¥è·³å‡ºï¼ˆShift+F11ï¼‰**ï¼šè·³å‡ºå½“å‰å‡½æ•°
- **é‡å¯ï¼ˆCtrl+Shift+F5ï¼‰**ï¼šé‡å¯è°ƒè¯•
- **åœæ­¢ï¼ˆShift+F5ï¼‰**ï¼šåœæ­¢è°ƒè¯•

### æ–¹æ³• 2ï¼šä½¿ç”¨ç»ˆç«¯è°ƒè¯•

#### å¯åŠ¨è°ƒè¯•æ¨¡å¼

```bash
npm run start:debug
```

è¾“å‡ºä¼šæ˜¾ç¤ºï¼š
```
Debugger listening on ws://127.0.0.1:9229/...
```

#### åœ¨ Chrome ä¸­è°ƒè¯•

1. æ‰“å¼€ Chrome æµè§ˆå™¨
2. è®¿é—®ï¼š`chrome://inspect`
3. ç‚¹å‡»"inspect"è¿æ¥åˆ° Node.js è¿›ç¨‹
4. åœ¨ Sources æ ‡ç­¾æ‰“æ–­ç‚¹

## ğŸ” æ–­ç‚¹ä¸ç”Ÿæ•ˆçš„å¸¸è§åŸå› 

### åŸå›  1ï¼šæ²¡æœ‰ä½¿ç”¨è°ƒè¯•æ¨¡å¼å¯åŠ¨

âŒ **é”™è¯¯ï¼š**
```bash
npm run start        # æ™®é€šæ¨¡å¼ï¼Œæ–­ç‚¹ä¸ç”Ÿæ•ˆ
npm run start:dev    # çƒ­é‡è½½æ¨¡å¼ï¼Œæ–­ç‚¹ä¸ç”Ÿæ•ˆ
```

âœ… **æ­£ç¡®ï¼š**
```bash
npm run start:debug  # è°ƒè¯•æ¨¡å¼ï¼Œæ–­ç‚¹ç”Ÿæ•ˆ
```

æˆ–åœ¨ VS Code ä¸­æŒ‰ **F5** å¯åŠ¨è°ƒè¯•ã€‚

### åŸå›  2ï¼šæ–­ç‚¹æ‰“åœ¨é”™è¯¯çš„æ–‡ä»¶

âŒ **é”™è¯¯ï¼šåœ¨ `dist` ç›®å½•æ‰“æ–­ç‚¹**
```
dist/auth/guards/roles.guard.js  â† ç¼–è¯‘åçš„æ–‡ä»¶
```

âœ… **æ­£ç¡®ï¼šåœ¨ `src` ç›®å½•æ‰“æ–­ç‚¹**
```
src/auth/guards/roles.guard.ts   â† æºä»£ç æ–‡ä»¶
```

### åŸå›  3ï¼šSource Map æœªç”Ÿæˆ

æ£€æŸ¥ `tsconfig.json`ï¼š

```json
{
  "compilerOptions": {
    "sourceMap": true  // â† å¿…é¡»ä¸º true
  }
}
```

âœ… ä½ çš„é…ç½®å·²ç»æ­£ç¡®ï¼

### åŸå›  4ï¼šä»£ç æœªé‡æ–°ç¼–è¯‘

å¦‚æœä¿®æ”¹äº†ä»£ç ï¼Œéœ€è¦é‡æ–°æ„å»ºï¼š

```bash
npm run build
```

æˆ–ä½¿ç”¨ `--watch` æ¨¡å¼è‡ªåŠ¨é‡æ–°ç¼–è¯‘ï¼š

```bash
npm run start:debug  # å¸¦ --watchï¼Œä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘
```

### åŸå›  5ï¼šæ–­ç‚¹æ¡ä»¶é”™è¯¯

å¦‚æœè®¾ç½®äº†æ¡ä»¶æ–­ç‚¹ï¼Œæ£€æŸ¥æ¡ä»¶æ˜¯å¦æ­£ç¡®ã€‚

å³é”®æ–­ç‚¹ â†’ ç¼–è¾‘æ–­ç‚¹ â†’ æ£€æŸ¥è¡¨è¾¾å¼

## ğŸ“‹ å®Œæ•´è°ƒè¯•æµç¨‹

### è°ƒè¯•æƒé™æ£€æŸ¥

å‡è®¾è¦è°ƒè¯• `src/auth/guards/roles.guard.ts` çš„æƒé™æ£€æŸ¥ï¼š

#### æ­¥éª¤ 1ï¼šæ‰“æ–­ç‚¹

åœ¨ `roles.guard.ts` çš„ç¬¬ 66 è¡Œæ‰“æ–­ç‚¹ï¼š

```typescript:src/auth/guards/roles.guard.ts
// æ£€æŸ¥è§’è‰²æƒé™
if (requiredRoles && requiredRoles.length > 0) {
  const hasRequiredRole = requiredRoles.includes(user.role); // â† åœ¨è¿™è¡Œæ‰“æ–­ç‚¹
  if (!hasRequiredRole) {
    throw new ForbiddenException(
      `éœ€è¦ä»¥ä¸‹è§’è‰²ä¹‹ä¸€: ${requiredRoles.join(', ')}`,
    );
  }
}
```

#### æ­¥éª¤ 2ï¼šå¯åŠ¨è°ƒè¯•

æŒ‰ `F5` æˆ–åœ¨è°ƒè¯•é¢æ¿é€‰æ‹©"è°ƒè¯• NestJS åº”ç”¨"

#### æ­¥éª¤ 3ï¼šå‘é€è¯·æ±‚

```bash
curl -X POST "http://localhost:3000/media/upload" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.jpg"
```

#### æ­¥éª¤ 4ï¼šæŸ¥çœ‹å˜é‡

å½“ä»£ç æš‚åœåœ¨æ–­ç‚¹æ—¶ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š
- `requiredRoles`ï¼šéœ€è¦çš„è§’è‰²åˆ—è¡¨
- `user.role`ï¼šå½“å‰ç”¨æˆ·çš„è§’è‰²
- `hasRequiredRole`ï¼šæ˜¯å¦æœ‰æƒé™

#### æ­¥éª¤ 5ï¼šåˆ†æé—®é¢˜

åœ¨"è°ƒè¯•æ§åˆ¶å°"æˆ–"å˜é‡"é¢æ¿æŸ¥çœ‹ï¼š
```
requiredRoles: ["TEACHER_LEADER", "TEACHER"]
user.role: "STUDENT"                          â† è¿™é‡Œå°±èƒ½çœ‹åˆ°è§’è‰²ä¸åŒ¹é…
hasRequiredRole: false
```

## ğŸ¯ å¿«é€Ÿæµ‹è¯•è°ƒè¯•é…ç½®

### æµ‹è¯• 1ï¼šç®€å•æ–­ç‚¹

1. åœ¨ `src/main.ts` çš„ç¬¬ 8 è¡Œæ‰“æ–­ç‚¹
2. æŒ‰ `F5` å¯åŠ¨è°ƒè¯•
3. åº”è¯¥ä¼šåœ¨å¯åŠ¨æ—¶æš‚åœ
4. æŒ‰ `F5` ç»§ç»­

### æµ‹è¯• 2ï¼šAPI è¯·æ±‚æ–­ç‚¹

1. åœ¨ `src/media/media.controller.ts` çš„ `uploadFile` æ–¹æ³•æ‰“æ–­ç‚¹
2. æŒ‰ `F5` å¯åŠ¨è°ƒè¯•
3. å‘é€ä¸Šä¼ è¯·æ±‚
4. åº”è¯¥ä¼šæš‚åœåœ¨æ–­ç‚¹å¤„

## ğŸ”§ VS Code è°ƒè¯•é…ç½®è¯´æ˜

### é…ç½® 1ï¼šè°ƒè¯• NestJS åº”ç”¨

```json
{
  "type": "node",
  "request": "launch",
  "name": "è°ƒè¯• NestJS åº”ç”¨",
  "runtimeExecutable": "npm",
  "runtimeArgs": ["run", "start:debug"],  // è¿è¡Œ npm run start:debug
  "console": "integratedTerminal",
  "restart": true,                         // ä»£ç æ”¹å˜æ—¶è‡ªåŠ¨é‡å¯
  "sourceMaps": true,                      // ä½¿ç”¨ source map
  "outFiles": ["${workspaceFolder}/dist/**/*.js"]  // ç¼–è¯‘è¾“å‡ºç›®å½•
}
```

### é…ç½® 2ï¼šé™„åŠ åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹

å¦‚æœå·²ç»è¿è¡Œäº† `npm run start:debug`ï¼Œå¯ä»¥ä½¿ç”¨æ­¤é…ç½®é™„åŠ ï¼š

```json
{
  "type": "node",
  "request": "attach",
  "name": "é™„åŠ åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹",
  "port": 9229,        // è°ƒè¯•ç«¯å£
  "restart": true
}
```

## ğŸ“Š è°ƒè¯•ç«¯å£

NestJS é»˜è®¤ä½¿ç”¨ç«¯å£ `9229` è¿›è¡Œè°ƒè¯•ï¼š

```bash
npm run start:debug
# è¾“å‡ºï¼šDebugger listening on ws://127.0.0.1:9229/...
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç«¯å£å†²çª

å¦‚æœ 9229 ç«¯å£è¢«å ç”¨ï¼Œä¿®æ”¹ `package.json`ï¼š

```json
"start:debug": "nest start --debug=9230 --watch"
```

åŒæ—¶ä¿®æ”¹ `.vscode/launch.json` ä¸­çš„ portã€‚

### 2. æ€§èƒ½å½±å“

è°ƒè¯•æ¨¡å¼ä¼šç•¥å¾®é™ä½æ€§èƒ½ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨ã€‚

### 3. æ–­ç‚¹ä½ç½®

- âœ… åœ¨å®é™…æ‰§è¡Œçš„ä»£ç è¡Œæ‰“æ–­ç‚¹
- âŒ ä¸è¦åœ¨ç±»å‹å®šä¹‰ã€æ¥å£ã€æ³¨é‡Šè¡Œæ‰“æ–­ç‚¹
- âŒ ä¸è¦åœ¨ç©ºè¡Œæ‰“æ–­ç‚¹

### 4. Watch æ¨¡å¼

ä½¿ç”¨ `start:debug` æ—¶ï¼Œä»£ç ä¿®æ”¹ä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œé‡å¯ã€‚

## ğŸ¨ VS Code è°ƒè¯•é¢æ¿

è°ƒè¯•æ—¶å¯ä»¥ä½¿ç”¨çš„é¢æ¿ï¼š

1. **å˜é‡**ï¼šæŸ¥çœ‹å½“å‰ä½œç”¨åŸŸçš„æ‰€æœ‰å˜é‡
2. **ç›‘è§†**ï¼šæ·»åŠ è¡¨è¾¾å¼ç›‘è§†ç‰¹å®šå€¼
3. **è°ƒç”¨å †æ ˆ**ï¼šæŸ¥çœ‹å‡½æ•°è°ƒç”¨é“¾
4. **æ–­ç‚¹**ï¼šç®¡ç†æ‰€æœ‰æ–­ç‚¹
5. **è°ƒè¯•æ§åˆ¶å°**ï¼šæ‰§è¡Œè¡¨è¾¾å¼å’Œå‘½ä»¤

## ğŸ’¡ è°ƒè¯•æŠ€å·§

### æŠ€å·§ 1ï¼šæ¡ä»¶æ–­ç‚¹

å³é”®æ–­ç‚¹ â†’ ç¼–è¾‘æ–­ç‚¹ â†’ æ·»åŠ æ¡ä»¶ï¼š

```javascript
user.email === '999@test.com'
```

åªæœ‰å½“æ¡ä»¶æ»¡è¶³æ—¶æ‰ä¼šæš‚åœã€‚

### æŠ€å·§ 2ï¼šæ—¥å¿—æ–­ç‚¹

å³é”®æ–­ç‚¹ â†’ ç¼–è¾‘æ–­ç‚¹ â†’ å‹¾é€‰"è®°å½•æ¶ˆæ¯"

```
ç”¨æˆ·è§’è‰²: {user.role}
```

ä¸ä¼šæš‚åœæ‰§è¡Œï¼Œåªè¾“å‡ºæ—¥å¿—ã€‚

### æŠ€å·§ 3ï¼šè°ƒè¯•æ§åˆ¶å°

åœ¨æ–­ç‚¹æš‚åœæ—¶ï¼Œå¯ä»¥åœ¨è°ƒè¯•æ§åˆ¶å°æ‰§è¡Œä»£ç ï¼š

```javascript
> user.role
"STUDENT"

> requiredRoles
["TEACHER_LEADER", "TEACHER"]

> requiredRoles.includes(user.role)
false
```

## ğŸ§ª å®æˆ˜ç¤ºä¾‹

### è°ƒè¯•ä¸Šä¼ æƒé™é—®é¢˜

#### ç›®æ ‡

æ‰¾å‡ºä¸ºä»€ä¹ˆ `999@test.com` æ— æ³•ä¸Šä¼ åª’ä½“

#### æ­¥éª¤

1. **æ‰“æ–­ç‚¹**
   - æ–‡ä»¶ï¼š`src/auth/guards/roles.guard.ts`
   - ä½ç½®ï¼šç¬¬ 66 è¡Œï¼ˆè§’è‰²æ£€æŸ¥ï¼‰

2. **å¯åŠ¨è°ƒè¯•**
   ```bash
   æŒ‰ F5
   ```

3. **å‘é€ä¸Šä¼ è¯·æ±‚**
   ```bash
   curl -X POST "http://localhost:3000/media/upload" \
     -H "Authorization: Bearer TOKEN" \
     -F "file=@test.jpg"
   ```

4. **ä»£ç æš‚åœåœ¨æ–­ç‚¹**
   - æŸ¥çœ‹ `user.role` çš„å€¼
   - æŸ¥çœ‹ `requiredRoles` çš„å€¼
   - å¯¹æ¯”æ˜¯å¦åŒ¹é…

5. **å‘ç°é—®é¢˜**
   ```
   user.role = "STUDENT"
   requiredRoles = ["TEACHER_LEADER", "TEACHER"]
   â†’ ä¸åŒ¹é…ï¼
   ```

6. **è§£å†³æ–¹æ¡ˆ**
   - ç”¨æˆ·é‡æ–°ç™»å½•è·å–æ–° Token
   - æ–° Token ä¸­ `user.role` ä¼šæ˜¯ "TEACHER"

## ğŸ é¢å¤–å·¥å…·

### VS Code æ’ä»¶æ¨è

1. **JavaScript Debugger** - VS Code å†…ç½®ï¼Œæ— éœ€å®‰è£…
2. **Error Lens** - å®æ—¶æ˜¾ç¤ºé”™è¯¯
3. **REST Client** - åœ¨ VS Code ä¸­å‘é€ HTTP è¯·æ±‚

### Chrome DevTools

å¦‚æœä½ ç†Ÿæ‚‰ Chrome è°ƒè¯•ï¼š

```bash
npm run start:debug

# ç„¶ååœ¨ Chrome è®¿é—®
chrome://inspect
```

## ğŸ“ å¿«é€Ÿå¸®åŠ©

### é—®é¢˜ï¼šæŒ‰ F5 æ²¡ååº”

**æ£€æŸ¥ï¼š**
1. æ˜¯å¦åœ¨é¡¹ç›®æ ¹ç›®å½•
2. æ˜¯å¦å®‰è£…äº† Node.js
3. VS Code æ˜¯å¦è¯†åˆ«ä¸º Node.js é¡¹ç›®

### é—®é¢˜ï¼šæ–­ç‚¹æ˜¾ç¤ºç°è‰²

**åŸå› ï¼š**
- Source map æœªç”Ÿæˆ
- æ–‡ä»¶è·¯å¾„ä¸åŒ¹é…

**è§£å†³ï¼š**
```bash
npm run build  # é‡æ–°æ„å»º
```

### é—®é¢˜ï¼šæ–­ç‚¹è·³è¿‡ä¸åœ

**åŸå› ï¼š**
- è¯¥ä»£ç æœªæ‰§è¡Œ
- æ–­ç‚¹åœ¨é”™è¯¯çš„åˆ†æ”¯

**è§£å†³ï¼š**
- æ£€æŸ¥ä»£ç é€»è¾‘
- åœ¨å‡½æ•°å…¥å£æ‰“æ–­ç‚¹

---

**ç°åœ¨æŒ‰ F5 å°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ï¼** ğŸ›

## ğŸ“‹ å¿«é€Ÿå‘½ä»¤

```bash
# å¯åŠ¨è°ƒè¯•æ¨¡å¼
npm run start:debug

# æˆ–åœ¨ VS Code ä¸­
æŒ‰ F5

# åœæ­¢è°ƒè¯•
Shift + F5
```

**åˆ›å»ºæ—¥æœŸ**ï¼š2025å¹´10æœˆ8æ—¥
